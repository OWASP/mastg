name: Document Export

on: [push]

jobs:
  Generate-Checklists:
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v2
      with:
        fetch-depth: 1
    
    - name: Listing repo recursive
      run: ls -lR

    - name: Set MSTG_VERSION to env 
      # run: echo "MSTG_VERSION=$(git describe --tags `git rev-list --tags --max-count=1`)" >> $GITHUB_ENV
      run: echo "MSTG_VERSION=$(curl -s https://api.github.com/repos/OWASP/owasp-mstg/releases/latest | jq '.tag_name' | sed 's/\"//g')" >> $GITHUB_ENV

    - name: Set DEV VERSION if it's not a tag
      if: ${{ !startsWith(github.ref, 'refs/tags/') }}
      run: echo "MSTG_VERSION=${{env.MSTG_VERSION}}-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

    - name: Confirm MSTG Current Tag
      run: echo ${{env.MSTG_VERSION}}

    - name: Get MSTG Current Commit ID
      run: echo "MSTG_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
    - name: Confirm MSTG Current Commit ID
      run: echo ${{env.MSTG_COMMIT}}
    
    - name: Get Latest MASVS Release Tag
      run: echo "MASVS_VERSION=$(curl -s https://api.github.com/repos/OWASP/owasp-masvs/releases/latest | jq '.tag_name' | sed 's/\"//g')" >> $GITHUB_ENV

    - name: Confirm MASVS Release Tag
      run: echo ${{env.MASVS_VERSION}}

    - uses: actions/checkout@v2
      with:
        repository: "OWASP/owasp-masvs.git"
        # ref: ${{env.MASVS_VERSION}}       # TODO RESTORE
        ref: master
        fetch-depth: 1
        path: tools/scripts/owasp-masvs

    - name: Get MASVS Current Commit ID
      run: cd tools/scripts/owasp-masvs && echo "MASVS_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
    - name: Confirm MSTG Current Commit ID
      run: echo ${{env.MASVS_COMMIT}}

    - name: Listing of scripts directory
      run: ls -l tools/scripts/

    - name: Install pip Requirements
      run: pip3 install -r tools/scripts/requirements.txt

    - name: Show openpyxl Version
      run: pip3 show openpyxl

    - name: Convert MSTG Testing Chapters to HTML
      run: . tools/scripts/mstg_to_html.sh

    - name: List MSTG HTML
      run: ls -l tools/scripts/generated/html/

    - name: Export YAML, enhance with MSTG and generate Excel
      run: cd tools/scripts && ./gen_all_excel.sh ${{env.MSTG_VERSION}} ${{env.MSTG_COMMIT}} ${{env.MASVS_VERSION}} ${{env.MASVS_COMMIT}}

    # - name: Upload MASVS YAML
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: MASVS YAML Files
    #     path: tools/scripts/masvs_*.yaml

    - name: Upload Enhanced MASVS YAML
      uses: actions/upload-artifact@v2
      with:
        name: Enhanced MASVS YAML Files
        path: tools/scripts/masvs_full_*.yaml

    - name: Upload Checklists
      uses: actions/upload-artifact@v2
      with:
        name: Checklists
        path: tools/scripts/*.xlsx